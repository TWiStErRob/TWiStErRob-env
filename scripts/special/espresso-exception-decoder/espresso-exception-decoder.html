<script>
	function parse(exception) {
		console.log("parsing");
		var match;

		match = /[\s\S]*(android\.support\.test\.espresso\.AmbiguousViewMatcherException): '(.*?)' matches multiple views in the hierarchy\.\nProblem views are marked with '(\*\*\*\*MATCHES\*\*\*\*)' below.\n\nView Hierarchy:\n([\s\S]*)/.exec(exception);
		if (match) {
			return parseViewException({
				ex: match[1],
				matcher: match[2],
				marker: match[3],
				hierarchyText: match[4]
			});
		}

		match = /[\s\S]*(android.support.test.espresso.NoMatchingViewException): No views in hierarchy found matching: \(?(.*?)\)?\n[\s\S]*View Hierarchy:\n([\s\S]*)/.exec(exception);
		if (match) {
			return parseViewException({
				ex: match[1],
				matcher: match[2],
				marker: '',
				hierarchyText: match[3]
			});
		}

		match = /[\s\S]*(android.support.test.espresso.NoMatchingRootException): Matcher '([\s\S]*?)' did not match any of the following roots: \[([\s\S]*)\]\n([\s\S]*)/.exec(exception);
		if(match) {
			return parseRootException({
				ex: match[1],
				matcher: match[2],
				marker: '',
				rootText: match[3]
			});
		}

		match = /[\s\S]*(java.lang.RuntimeException): No data found matching: \(?(.*?)\)? contained values: \<\[([\s\S]*?)\]\>([\s\S]*)/.exec(exception);
		if (match) {
			return parseDataException({
				ex: match[1],
				matcher: match[2],
				dataText: match[3]
			});
		}
		
		throw "Cannot match " + exception;
	}
	function parseViewException(result) {
		result.hierarchyArray = result.hierarchyText.split("\n|\n");
		var last = result.hierarchyArray[result.hierarchyArray.length - 1];
		if (/^\s*at/.test(last)) {
			result.stacktrace = last; // TODO stack trace contains stuff after the "at " lines
			result.hierarchyArray = result.hierarchyArray.splice(0, result.hierarchyArray.length - 1);
		} else {
			result.stacktrace = null;
		}
		var views = toViews(result.hierarchyArray, result.marker);
		result.hierarchy = build(views);
		result.resNames = collect(views, 'res-name');
		result.types = collect(views, 'name');
		return result;
	}
	function parseDataException(result) {
		result.data = [];
		var match, dataRe = /Data: (.*?) \(class: (.*?)\) token: (\d+)(?:, |$)/g;
		while (match = dataRe.exec(result.dataText)) {
			var row = {
				token: match[3],
				class: match[2],
				data: match[1]
			};
			if (row.class == 'android.database.sqlite.SQLiteCursor') {
				rowMatch = /Row (\d+): \{(.*)\}/.exec(row.data);
				var props = parseProps({'row #': rowMatch[1]}, rowMatch[2]);
				for (var p in props) {
					if (props.hasOwnProperty(p)) {
						row['data-' + p] = props[p];
					}
				}
			}
			result.data.push(row);
		}
		return result;
	}
	function parseRootException(result) {
		result.roots = [];
		var match, dataRe = /Root\{(?:application-window-token=(.*?), window-token=(.*?), has-window-focus=(.*?), (?:layout-params-type=(.*?), )?(?:layout-params-string=(.*?), )?decor-view-string=(.*?\}))\}/g;
		while (match = dataRe.exec(result.rootText)) {
			var root = {
				'application-window-token': match[1],
				'window-token': match[2],
				'has-window-focus': match[3],
				//'decor-view-string': match[6],
			};
			root.children = [];
			if (match[4]) {
				root['layout-params-type'] = match[4];
				//root['layout-params-string'] = match[5];
				var paramsMatch = /(.*?)\{\((\d+),(\d+)\)\((\d+|fill|wrap)x(\d+|fill|wrap)\) (.*)\}/.exec(match[5]);
				var params = {
					name: paramsMatch[1],
					x: paramsMatch[2],
					y: paramsMatch[3],
					width: paramsMatch[4],
					height: paramsMatch[5]
				};
				parseProps(params, paramsMatch[6]);
				for (var p in params) {
					if (params.hasOwnProperty(p)) {
						root[/*'layout-params-' +*/ p] = params[p];
					}
				}
				root['layout-params-class'] = params.name;
				//root.children.push(params);
			}
			root.children.push(parseView('+>' + match[6], ''));
			result.roots.push(root);
		}
		return result;
	}
	function collect(arr, prop) {
		var set = {};
		for (var i = 0; i < arr.length; ++i) {
			set[arr[i][prop]] = true;
		}
		delete set[undefined];
		var result = [];
		for (var p in set) {
			if (set.hasOwnProperty(p)) {
				result.push(p);
			}
		}
		result.sort();
		return result;
	}
	function escapeRegExp(str) {
		// noinspection *
		return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
	}
	function parseView(text, marker) {
		var regex = new RegExp('^\\+(-*)>(.*?)\\{id=(-?\\d+), ([\\s\\S]+)\\}( ' + escapeRegExp(marker) + ')?$');
		var match = regex.exec(text);
		if (!match) throw "Cannot parse view: " + text;
		var view = {
			level: match[1].length,
			name: match[2],
			id: match[3],
			matches: !!match[5],
			children: []
		};
		var rest = match[4];
		parseProps(view, rest);
		if (view['editor-info']) {
			var info = view['editor-info'];
			delete view['editor-info'];
			info = info.substring(1, info.length - 1);
			var infoRe = /(.*?)=(.*?)( (?=\w+=)|$)/g;
			while (match = infoRe.exec(info)) {
				view['ei-' + match[1]] = match[2];
			}
		}
		return view;
	}
	function parseProps(view, rest) {
		var propRe = /(.*?)[=:]([\s\S]*?)(,? (?=[\w-]+[=:])|$)/g;
		while (match = propRe.exec(rest)) {
			view[match[1]] = match[2];
		}
		return view;
	}
	function toViews(input, marker) {
		var output = [];
		for (var i = 0; i < input.length; ++i) {
			output.push(parseView(input[i], marker));
		}
		return output;
	}
	function build(views) {
		var stack = [];
		for (var i = 0; i < views.length; ++i) {
			var view = views[i];
			if (view.level > stack.length) {
				throw JSON.stringify(view) + " is deeper than " + stack.length + ": missing some parents.";
			} else while (view.level < stack.length) {
				//console.log("Popping " + view.name);
				stack.pop();
			}
			var parent = stack.pop();
			if (parent) {
				//console.log("Parent of " + view.name + " is " + parent.name);
				parent.children.push(view);
				view.parent = parent;
				stack.push(parent);
			}
			if (view.level == stack.length) {
				//console.log("Pushing " + view.name);
				stack.push(view);
			}
		}
		return views[0];
	}
	function render(error) {
		if (error.hierarchy) {
			return renderHierarchy(error);
		} else if (error.data) {
			return renderData(error);
		} else if (error.roots) {
			return renderRoots(error);
		} else {
			throw 'Cannot render ' + JSON.stringify(error);
		}
	}
	function renderRoots(error) {
		var hierarchyTreeDom = document.getElementById('hierarchy-tree');
		while (hierarchyTreeDom.firstChild) {
			hierarchyTreeDom.removeChild(hierarchyTreeDom.firstChild);
		}
		var hierarchyTreeRootDomUl = document.createElement('ul');
		for(var i = 0; i < error.roots.length; ++i) {
			var root = error.roots[i];
			root.name = root['window-token'];
			root._display = document.createElement('span');
			for(var c = 0; c < root.children.length; ++c) {
				var child = root.children[c];
				child._display = document.createElement('span');
				child.children = child.children || [];
			}

			var hierarchyTreeRootDomLi = document.createElement('li');
			renderTree(hierarchyTreeRootDomLi, root);
			hierarchyTreeRootDomUl.appendChild(hierarchyTreeRootDomLi);
		}
		hierarchyTreeDom.appendChild(hierarchyTreeRootDomUl);
	}
	function renderData(error) {
		var hierarchyTreeDom = document.getElementById('hierarchy-tree');
		while (hierarchyTreeDom.firstChild) {
			hierarchyTreeDom.removeChild(hierarchyTreeDom.firstChild);
		}
		var hierarchyTreeRootDomUl = document.createElement('ul');
		for(var i = 0; i < error.data.length; ++i) {
			var d = error.data[i];
			d.name = d.class;
			d.children = [];
			d._display = document.createElement('span');

			var hierarchyTreeRootDomLi = document.createElement('li');
			renderTree(hierarchyTreeRootDomLi, d);
			hierarchyTreeRootDomUl.appendChild(hierarchyTreeRootDomLi);
		}
		hierarchyTreeDom.appendChild(hierarchyTreeRootDomUl);
	}
	function renderHierarchy(error) {
		var h = error.hierarchy;

		var messageDom = document.getElementById('message');
		messageDom.error = error;
		messageDom.innerHTML = "<b>" + error.ex + "</b>: " + error.matcher;

		var hierarchyDom = document.getElementById('hierarchy-display');
		while (hierarchyDom.firstChild) {
			hierarchyDom.removeChild(hierarchyDom.firstChild);
		}		
		hierarchyDom.style.paddingBottom = h.height / h.width * 100 + '%';
		renderView(hierarchyDom, h, 100 / h.width, 100 / h.height);
		var hierarchyTreeDom = document.getElementById('hierarchy-tree');
		while (hierarchyTreeDom.firstChild) {
			hierarchyTreeDom.removeChild(hierarchyTreeDom.firstChild);
		}
		var hierarchyTreeRootDomUl = document.createElement('ul');
		var hierarchyTreeRootDomLi = document.createElement('li');
		renderTree(hierarchyTreeRootDomLi, h);
		hierarchyTreeRootDomUl.appendChild(hierarchyTreeRootDomLi);
		hierarchyTreeDom.appendChild(hierarchyTreeRootDomUl);
	}
	String.prototype.hashCode = function () {
		var hash = 0, i, chr, len;
		if (this.length === 0) return hash;
		for (i = 0, len = this.length; i < len; i++) {
			chr = this.charCodeAt(i);
			hash = ((hash << 5) - hash) + chr;
			hash |= 0; // Convert to 32bit integer
		}
		return hash;
	};
	function renderView(target, view, scaleX, scaleY) {
		var dom = document.createElement('div');
		view._display = dom;
		dom.view = view;
		dom.addEventListener('mouseover', function (e) {
			e.stopPropagation();
			showView(e.currentTarget.view);
		});
		dom.className = ['view', view.name, view.visibility, view.matches ? 'MATCHES' : ''].join(' ');
		dom.style.width = view.width * scaleX + '%';
		dom.style.height = view.height * scaleY + '%';
		dom.style.left = view.x * scaleX + '%';
		dom.style.top = view.y * scaleY + '%';
		dom.style.backgroundColor = dom.className.hashCode().toString(16);
		dom.setAttribute('data-type', view.name);
		if (view.text) {
			dom.innerText = view.text;
		}
		target.appendChild(dom);
		for (var i = 0; i < view.children.length; ++i) {
			renderView(dom, view.children[i], 100 / view.width, 100 / view.height);
		}
	}
	function renderTree(target, view) {
		view._tree = target;
		target.view = view;
		target.addEventListener('mouseover', function (e) {
			e.stopPropagation();
			showView(e.currentTarget.view);
		});
		target.className = ['view', view.name, view.visibility, view.matches ? 'MATCHES' : ''].join(' ');
		target.setAttribute('data-type', view.name);
		var name = document.createElement('span');
		name.innerText = view.name;
		name.className = 'name';
		target.appendChild(name);
		if(view.children.length) {
			var children = document.createElement('ul');
			for (var i = 0; i < view.children.length; ++i) {
				var child = document.createElement('li');
				renderTree(child, view.children[i]);
				children.appendChild(child);
			}
			target.appendChild(children);
		}
	}
	function parents(view) {
		var parents = [];
		view = view.parent;
		while (view) {
			parents.push(view.name + (view['res-name'] ? " (" + view['res-name'] + ")" : ""));
			view = view.parent;
		}
		parents.reverse();
		return parents;
	}
	var lastView;
	function showView(view) {
		if (lastView) {
			lastView._display.classList.remove('highlight');
			lastView._tree.classList.remove('highlight');
		}
		lastView = view;
		if (!view) return;
		view._display.classList.add('highlight');
		view._tree.classList.add('highlight');

		document.getElementById('name').innerText = view.name;
		document.getElementById('path').innerText = "in " + parents(view).join(' > ');

		var props = document.getElementById('properties');
		while (props.firstChild) {
			props.removeChild(props.firstChild);
		}
		var propsToShow = [];
		var exclusions = ['children', 'parent', 'name', 'matches', '_display', '_tree'];
		for (var x in view) {
			if (!view.hasOwnProperty(x) || exclusions.indexOf(x) !== -1) continue;
			propsToShow.push(x);
		}
		var priorities = {
			'^id': 10,
			'^token': 10,
			'^res-name': 11,
			'^matches': 12,
			'^name': 20,
			'^class': 20,
			'^text': 30,
			'^data': 31,
			'^desc': 31,
			'^level': 40,
			'^width': 41,
			'^height': 42,
			'^x': 43,
			'^y': 44,
			'^ei-.*': Infinity
		};

		function getPriority(x) {
			for (var re in priorities) {
				if (priorities.hasOwnProperty(re)) {
					if (new RegExp(re).test(x)) {
						return priorities[re];
					}
				}
			}
			return 100000;
		}

		propsToShow.sort(function (a, b) {
			var pa = getPriority(a);
			var pb = getPriority(b);
			var c = pa < pb ? -1 : (pa > pb ? 1 : 0);
			return c !== 0 ? c : (a < b ? -1 : (a > b ? 1 : 0));
		});
		for (var i = 0; i < propsToShow.length; ++i) {
			var prop = propsToShow[i];
			var propName = document.createElement('dt');
			var propValue = document.createElement('dd');
			propName.innerText = prop;
			propValue.innerText = view[prop];
			props.appendChild(propName);
			props.appendChild(propValue);
		}
	}
</script>
<script>
	var output = document.getElementById('output-container');
	var input = document.getElementById('trace');
	var message = document.getElementById('message');
	var border = document.getElementById('border-type');
	var names = document.getElementById('name-display');
	border.addEventListener('change', function () {
		for (var i = 0; i < border.options.length; ++i) {
			var optionClasses = border.options[i].value.split(' ');
			for (var c = 0; c < optionClasses.length; ++c) {
				output.classList.remove(optionClasses[c]);
			}
		}
		var classes = border.value.split(' ');
		for (var c = 0; c < classes.length; ++c) {
			output.classList.add(classes[c]);
		}
	});
	input.addEventListener('input', function () {
		render(parse(input.value))
	});
	render(parse(input.value));
	names.addEventListener('change', function () {
		if (names.checked) {
			output.classList.add('show-names');
		} else {
			output.classList.remove('show-names');
		}
	});
	message.addEventListener('click', function () {
		document.getElementById('name').innerText = "Statistics";
		document.getElementById('path').innerText = "";
		var error = this.error;
		document.getElementById('properties').innerHTML =
				"<dt>Available res-names</dt><dd>" + error.resNames.join(", ") + "</dd>"
				+ "<dt>Available classes</dt><dd>" + error.types.join(", ") + "</dd>"
	})
</script>
