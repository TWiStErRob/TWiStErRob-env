<script>

	function parseDataException(result) {
		result.data = [];
		var match, dataRe = /Data: (.*?) \(class: (.*?)\) token: (\d+)(?:, |$)/g;
		while (match = dataRe.exec(result.dataText)) {
			var row = {
				token: match[3],
				class: match[2],
				data: match[1]
			};
			if (row.class == 'android.database.sqlite.SQLiteCursor') {
				rowMatch = /Row (\d+): \{(.*)\}/.exec(row.data);
				var props = parseProps({'row #': rowMatch[1]}, rowMatch[2]);
				for (var p in props) {
					if (props.hasOwnProperty(p)) {
						row['data-' + p] = props[p];
					}
				}
			}
			result.data.push(row);
		}
		return result;
	}
	function parseRootException(result) {
		result.roots = [];
		var match, dataRe = /Root\{(?:application-window-token=(.*?), window-token=(.*?), has-window-focus=(.*?), (?:layout-params-type=(.*?), )?(?:layout-params-string=(.*?), )?decor-view-string=(.*?\}))\}/g;
		while (match = dataRe.exec(result.rootText)) {
			var root = {
				'application-window-token': match[1],
				'window-token': match[2],
				'has-window-focus': match[3],
				//'decor-view-string': match[6],
			};
			root.children = [];
			if (match[4]) {
				root['layout-params-type'] = match[4];
				//root['layout-params-string'] = match[5];
				var paramsMatch = /(.*?)\{\((\d+),(\d+)\)\((\d+|fill|wrap)x(\d+|fill|wrap)\) (.*)\}/.exec(match[5]);
				var params = {
					name: paramsMatch[1],
					x: paramsMatch[2],
					y: paramsMatch[3],
					width: paramsMatch[4],
					height: paramsMatch[5]
				};
				parseProps(params, paramsMatch[6]);
				for (var p in params) {
					if (params.hasOwnProperty(p)) {
						root[/*'layout-params-' +*/ p] = params[p];
					}
				}
				root['layout-params-class'] = params.name;
				//root.children.push(params);
			}
			root.children.push(parseView('+>' + match[6], ''));
			result.roots.push(root);
		}
		return result;
	}
	function collect(arr, prop) {
		var set = {};
		for (var i = 0; i < arr.length; ++i) {
			set[arr[i][prop]] = true;
		}
		delete set[undefined];
		var result = [];
		for (var p in set) {
			if (set.hasOwnProperty(p)) {
				result.push(p);
			}
		}
		result.sort();
		return result;
	}

	function renderRoots(error) {
		var hierarchyTreeDom = document.getElementById('hierarchy-tree');
		while (hierarchyTreeDom.firstChild) {
			hierarchyTreeDom.removeChild(hierarchyTreeDom.firstChild);
		}
		var hierarchyTreeRootDomUl = document.createElement('ul');
		for(var i = 0; i < error.roots.length; ++i) {
			var root = error.roots[i];
			root.name = root['window-token'];
			root._display = document.createElement('span');
			for(var c = 0; c < root.children.length; ++c) {
				var child = root.children[c];
				child._display = document.createElement('span');
				child.children = child.children || [];
			}

			var hierarchyTreeRootDomLi = document.createElement('li');
			renderTree(hierarchyTreeRootDomLi, root);
			hierarchyTreeRootDomUl.appendChild(hierarchyTreeRootDomLi);
		}
		hierarchyTreeDom.appendChild(hierarchyTreeRootDomUl);
	}
	function renderData(error) {
		var hierarchyTreeDom = document.getElementById('hierarchy-tree');
		while (hierarchyTreeDom.firstChild) {
			hierarchyTreeDom.removeChild(hierarchyTreeDom.firstChild);
		}
		var hierarchyTreeRootDomUl = document.createElement('ul');
		for(var i = 0; i < error.data.length; ++i) {
			var d = error.data[i];
			d.name = d.class;
			d.children = [];
			d._display = document.createElement('span');

			var hierarchyTreeRootDomLi = document.createElement('li');
			renderTree(hierarchyTreeRootDomLi, d);
			hierarchyTreeRootDomUl.appendChild(hierarchyTreeRootDomLi);
		}
		hierarchyTreeDom.appendChild(hierarchyTreeRootDomUl);
	}
	var lastView;
	function showView(view) {
		if (lastView) {
			lastView._display.classList.remove('highlight');
			lastView._tree.classList.remove('highlight');
		}
		lastView = view;
		if (!view) return;
		view._display.classList.add('highlight');
		view._tree.classList.add('highlight');

		document.getElementById('name').innerText = view.name;
		document.getElementById('path').innerText = "in " + parents(view).join(' > ');

		var props = document.getElementById('properties');
		while (props.firstChild) {
			props.removeChild(props.firstChild);
		}
		var propsToShow = [];
		var exclusions = ['children', 'parent', 'name', 'matches', '_display', '_tree'];
		for (var x in view) {
			if (!view.hasOwnProperty(x) || exclusions.indexOf(x) !== -1) continue;
			propsToShow.push(x);
		}
		var priorities = {
			'^id': 10,
			'^token': 10,
			'^res-name': 11,
			'^matches': 12,
			'^name': 20,
			'^class': 20,
			'^text': 30,
			'^data': 31,
			'^desc': 31,
			'^level': 40,
			'^width': 41,
			'^height': 42,
			'^x': 43,
			'^y': 44,
			'^ei-.*': Infinity
		};

		function getPriority(x) {
			for (var re in priorities) {
				if (priorities.hasOwnProperty(re)) {
					if (new RegExp(re).test(x)) {
						return priorities[re];
					}
				}
			}
			return 100000;
		}

		propsToShow.sort(function (a, b) {
			var pa = getPriority(a);
			var pb = getPriority(b);
			var c = pa < pb ? -1 : (pa > pb ? 1 : 0);
			return c !== 0 ? c : (a < b ? -1 : (a > b ? 1 : 0));
		});
		for (var i = 0; i < propsToShow.length; ++i) {
			var prop = propsToShow[i];
			var propName = document.createElement('dt');
			var propValue = document.createElement('dd');
			propName.innerText = prop;
			propValue.innerText = view[prop];
			props.appendChild(propName);
			props.appendChild(propValue);
		}
	}
</script>
